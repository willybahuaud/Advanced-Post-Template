(()=>{"use strict";const t=window.React,e=window.wp.i18n,a=window.wp.hooks,n=window.wp.compose,r=window.wp.blockEditor,o=window.wp.element,c=window.wp.data,s=window.wp.components,i=s.NumberControl||s.__experimentalNumberControl,l={aptStartFrom:{type:"number",default:0},aptShowCount:{type:"number",default:0},aptSkipLast:{type:"number",default:0}};(0,a.addFilter)("blocks.registerBlockType","wabeo/apt-extend-attrs",(t,e)=>"core/post-template"!==e?t:{...t,attributes:{...t.attributes,...l}});const d=t=>{if(!t)return null;let e=document.querySelector(`[data-block="${t}"]`);if(e)return e;const a=Array.from(document.querySelectorAll('iframe[name="editor-canvas"], .editor-canvas iframe, iframe.components-iframe__frame'));for(const n of a)try{const a=n.contentDocument||n.contentWindow?.document;if(!a)continue;if(e=a.querySelector(`[data-block="${t}"]`),e)return e}catch(t){}return null},p=t=>t?t.matches&&t.matches("ul.wp-block-post-template, ol.wp-block-post-template")?t:t.querySelector("ul.wp-block-post-template, ol.wp-block-post-template"):null,m=(t,e)=>{if(!e)return;const a=e.getElementById(`apt-style-${t}`);a&&a.remove()},u=t=>{if(!t)return;const e=d(t),a=e&&(e.ownerDocument||{}).defaultView||window,n=(a&&a.wp&&a.wp.data&&a.wp.data.select?a.wp.data.select:c.select)("core/block-editor").getBlock(t);if(!n)return;const{aptStartFrom:r=0,aptShowCount:o=0,aptSkipLast:s=0}=n.attributes||{};if(!e)return;const i=`[data-block="${t}"]`;((t,e,a)=>{if(!e)return;const n=`apt-style-${t}`;let r=e.getElementById(n);r||(r=e.createElement("style"),r.type="text/css",r.id=n,(e.head||e.documentElement).appendChild(r)),r.textContent=a||""})(t,e.ownerDocument||document,`${i} ul.wp-block-post-template, ${i} ol.wp-block-post-template, ${i}.wp-block-post-template > li[data-apt-hidden="1"]{display:none !important;}`);const l=p(e);if(!l)return;const m=(t=>{if(!t)return[];const e=Array.from(t.children).filter(t=>"LI"===t.tagName);return e.forEach(t=>{t.dataset&&"1"===t.dataset.aptHidden&&delete t.dataset.aptHidden}),e.filter(t=>{const e=(t.ownerDocument||document).defaultView.getComputedStyle(t);return e&&"none"!==e.display})})(l),u=m.length;if(0===u)return;const w=Math.max(0,parseInt(r||0,10)),f=Math.max(0,parseInt(o||0,10)),h=Math.max(0,parseInt(s||0,10)),b=Math.max(0,u-h),k=f>0?Math.min(w+f,b):b;m.forEach((t,e)=>{(e<w||e>=k)&&t.dataset&&(t.dataset.aptHidden="1")})},w=new Map,f=new Map,h=t=>{if(w.has(t))return;let e=0;const a=()=>{e&&cancelAnimationFrame(e),e=requestAnimationFrame(()=>u(t))},n=new MutationObserver(()=>a());let r=!1,o=0;const c=()=>{const e=d(t);if(!e)return!1;const a=p(e)||e;try{return n.observe(a,{childList:!0,subtree:!0}),r=!0,!0}catch(t){return!1}};if(!c()){let t=0;const e=()=>{t+=1,r||t>40||(c()?a():o=window.setTimeout(e,250))};o=window.setTimeout(e,250)}a(),w.set(t,{disconnect:()=>{e&&cancelAnimationFrame(e),n.disconnect(),o&&window.clearTimeout(o)}})},b=t=>{Array.from(w.keys()).forEach(e=>{if(!t.has(e)){const t=w.get(e);t&&t.disconnect&&t.disconnect(),w.delete(e),f.delete(e),m(e,document),Array.from(document.querySelectorAll('iframe[name="editor-canvas"], .editor-canvas iframe, iframe.components-iframe__frame')).forEach(t=>{const a=t.contentDocument||t.contentWindow?.document;a&&m(e,a)})}})},k=t=>{const e=[],a=Array.isArray(t)?[...t]:[];for(;a.length;){const t=a.shift();t&&(e.push(t),Array.isArray(t.innerBlocks)&&t.innerBlocks.length&&a.unshift(...t.innerBlocks))}return e};let y=new Set;const I=new WeakSet,S=new WeakMap,E=t=>{if(!(t&&t.wp&&t.wp.data&&t.wp.data.select&&t.wp.data.subscribe))return;if(S.has(t))return;const e=t.wp.data.subscribe(()=>{try{const e=t.wp.data.select("core/block-editor").getBlocks();if(!Array.isArray(e))return;const a=k(e).filter(t=>"core/post-template"===t?.name),n=new Set(a.map(t=>t.clientId));a.forEach(t=>{h(t.clientId);const e={s:parseInt(t.attributes?.aptStartFrom||0,10),c:parseInt(t.attributes?.aptShowCount||0,10),k:parseInt(t.attributes?.aptSkipLast||0,10)},a=f.get(t.clientId);a&&a.s===e.s&&a.c===e.c&&a.k===e.k||(f.set(t.clientId,e),u(t.clientId))}),b(n),y=new Set(n)}catch(t){}});S.set(t,e)},A=()=>{Array.from(w.values()).forEach(t=>t.disconnect&&t.disconnect()),w.clear(),Array.from(y).forEach(t=>{h(t),u(t)})},g=()=>{Array.from(document.querySelectorAll('iframe[name="editor-canvas"], .editor-canvas iframe, iframe.components-iframe__frame')).forEach(t=>{if(!I.has(t)){I.add(t),t.addEventListener("load",()=>{const e=t.contentWindow;try{if(e&&e.wp&&e.wp.data&&e.wp.data.select){const t=e.wp.data.select("core/block-editor").getBlocks(),a=k(t).filter(t=>"core/post-template"===t?.name);y=new Set(a.map(t=>t.clientId)),a.forEach(t=>{h(t.clientId),u(t.clientId),f.set(t.clientId,{s:parseInt(t.attributes?.aptStartFrom||0,10),c:parseInt(t.attributes?.aptShowCount||0,10),k:parseInt(t.attributes?.aptSkipLast||0,10)})}),E(e)}else A()}catch(t){A()}});try{t.contentWindow&&E(t.contentWindow)}catch(t){}}})},v=new MutationObserver(()=>g());try{v.observe(document.documentElement,{childList:!0,subtree:!0})}catch(t){}g(),(0,c.subscribe)(()=>{const t=(0,c.select)("core/block-editor").getBlocks();if(!Array.isArray(t))return;const e=k(t).filter(t=>"core/post-template"===t?.name),a=new Set(e.map(t=>t.clientId));e.forEach(t=>{h(t.clientId);const e={s:parseInt(t.attributes?.aptStartFrom||0,10),c:parseInt(t.attributes?.aptShowCount||0,10),k:parseInt(t.attributes?.aptSkipLast||0,10)},a=f.get(t.clientId);a&&a.s===e.s&&a.c===e.c&&a.k===e.k||(f.set(t.clientId,e),u(t.clientId))}),b(a),y=new Set(a)});const C=(0,n.createHigherOrderComponent)(a=>n=>{if("core/post-template"!==n.name)return(0,t.createElement)(a,{...n});const{attributes:c,setAttributes:l}=n,{aptStartFrom:d,aptShowCount:p,aptSkipLast:m}=c;return(0,o.useEffect)(()=>{n.clientId&&(u(n.clientId),h(n.clientId))},[n.clientId]),(0,o.useEffect)(()=>{n.clientId&&u(n.clientId)},[n.clientId,d,p,m]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a,{...n}),(0,t.createElement)(r.InspectorControls,null,(0,t.createElement)(s.PanelBody,{title:(0,e.__)("Tronquer l’affichage","advanced-post-template"),initialOpen:!0},(0,t.createElement)(i,{label:(0,e.__)("Tronquer au début","advanced-post-template"),min:0,value:d,onChange:t=>l({aptStartFrom:parseInt(t||0,10)||0})}),(0,t.createElement)(i,{label:(0,e.__)("Maximum à afficher (0 = tous)","advanced-post-template"),min:0,value:p,onChange:t=>l({aptShowCount:Math.max(0,parseInt(t||0,10)||0)})}),(0,t.createElement)(i,{label:(0,e.__)("Tronquer à la fin","advanced-post-template"),min:0,value:m,onChange:t=>l({aptSkipLast:Math.max(0,parseInt(t||0,10)||0)})}))))},"withAPTControls");(0,a.addFilter)("editor.BlockEdit","wabeo/apt-controls",C)})();