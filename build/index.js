(()=>{"use strict";const t=window.React,e=window.wp.i18n,n=window.wp.hooks,a=window.wp.compose,r=window.wp.blockEditor,o=window.wp.element,c=window.wp.data,s=window.wp.components,i=s.NumberControl||s.__experimentalNumberControl,l={aptStartFrom:{type:"number",default:0},aptShowCount:{type:"number",default:0},aptSkipLast:{type:"number",default:0}};(0,n.addFilter)("blocks.registerBlockType","wabeo/apt-extend-attrs",(t,e)=>"core/post-template"!==e?t:{...t,attributes:{...t.attributes,...l}});const d=t=>{if(!t)return null;const e=Array.from(document.querySelectorAll('iframe[name="editor-canvas"], .editor-canvas iframe, iframe.components-iframe__frame'));for(const n of e)try{const e=n.contentDocument||n.contentWindow?.document;if(!e)continue;const a=e.querySelector(`[data-block="${t}"]`);if(a)return a}catch(t){}return document.querySelector(`[data-block="${t}"]`)||null},p=t=>t?t.matches&&t.matches("ul.wp-block-post-template, ol.wp-block-post-template")?t:t.querySelector("ul.wp-block-post-template, ol.wp-block-post-template"):null,m=(t,e)=>{if(!e)return;const n=e.getElementById(`apt-style-${t}`);n&&n.remove()},u=t=>{if(!t)return;const e=d(t),n=e&&(e.ownerDocument||{}).defaultView||window,a=(n&&n.wp&&n.wp.data&&n.wp.data.select?n.wp.data.select:c.select)("core/block-editor").getBlock(t);if(!a)return;const{aptStartFrom:r=0,aptShowCount:o=0,aptSkipLast:s=0}=a.attributes||{};if(!e)return;const i=`[data-block="${t}"]`;((t,e,n)=>{if(!e)return;const a=`apt-style-${t}`;let r=e.getElementById(a);r||(r=e.createElement("style"),r.type="text/css",r.id=a,(e.head||e.documentElement).appendChild(r)),r.textContent=n||""})(t,e.ownerDocument||document,`${i} ul.wp-block-post-template, ${i} ol.wp-block-post-template, ${i}.wp-block-post-template > li[data-apt-hidden="1"]{display:none !important;}`);const l=p(e);if(!l)return;const m=(t=>{if(!t)return[];const e=Array.from(t.children).filter(t=>"LI"===t.tagName);return e.forEach(t=>{t.dataset&&"1"===t.dataset.aptHidden&&delete t.dataset.aptHidden}),e.filter(t=>{const e=(t.ownerDocument||document).defaultView.getComputedStyle(t);return e&&"none"!==e.display})})(l),u=m.length;if(0===u)return;const w=Math.max(0,parseInt(r||0,10)),f=Math.max(0,parseInt(o||0,10)),h=Math.max(0,parseInt(s||0,10)),b=Math.max(0,u-h),y=f>0?Math.min(w+f,b):b;m.forEach((t,e)=>{(e<w||e>=y)&&t.dataset&&(t.dataset.aptHidden="1")})},w=new Map,f=new Map,h=t=>{if(w.has(t))return;let e=0;const n=()=>{e&&cancelAnimationFrame(e),e=requestAnimationFrame(()=>u(t))},a=new MutationObserver(()=>n());let r=!1,o=0;const c=()=>{const e=d(t);if(!e)return!1;const n=p(e)||e;try{return a.observe(n,{childList:!0,subtree:!0}),r=!0,!0}catch(t){return!1}};if(!c()){let t=0;const e=()=>{t+=1,r||t>40||(c()?n():o=window.setTimeout(e,250))};o=window.setTimeout(e,250)}n(),w.set(t,{disconnect:()=>{e&&cancelAnimationFrame(e),a.disconnect(),o&&window.clearTimeout(o)}})},b=t=>{Array.from(w.keys()).forEach(e=>{if(!t.has(e)){const t=w.get(e);t&&t.disconnect&&t.disconnect(),w.delete(e),f.delete(e),m(e,document),Array.from(document.querySelectorAll('iframe[name="editor-canvas"], .editor-canvas iframe, iframe.components-iframe__frame')).forEach(t=>{const n=t.contentDocument||t.contentWindow?.document;n&&m(e,n)})}})},y=t=>{const e=[],n=Array.isArray(t)?[...t]:[];for(;n.length;){const t=n.shift();t&&(e.push(t),Array.isArray(t.innerBlocks)&&t.innerBlocks.length&&n.unshift(...t.innerBlocks))}return e};let k=new Set;const I=new WeakSet,S=new WeakMap,E=(t,e)=>{let n=0;const a=()=>{try{if(t&&t.wp&&t.wp.data&&t.wp.data.select&&t.wp.data.subscribe)return void e()}catch(t){}n++<200&&setTimeout(a,50)};a()},A=t=>{if(!(t&&t.wp&&t.wp.data&&t.wp.data.select&&t.wp.data.subscribe))return;if(S.has(t))return;const e=t.wp.data.subscribe(()=>{try{const e=t.wp.data.select("core/block-editor").getBlocks();if(!Array.isArray(e))return;const n=y(e).filter(t=>"core/post-template"===t?.name),a=new Set(n.map(t=>t.clientId));n.forEach(t=>{h(t.clientId);const e={s:parseInt(t.attributes?.aptStartFrom||0,10),c:parseInt(t.attributes?.aptShowCount||0,10),k:parseInt(t.attributes?.aptSkipLast||0,10)},n=f.get(t.clientId);n&&n.s===e.s&&n.c===e.c&&n.k===e.k||(f.set(t.clientId,e),u(t.clientId))}),b(a),k=new Set(a)}catch(t){}});S.set(t,e);try{const e=t.wp.data.select("core/block-editor").getBlocks();if(Array.isArray(e)){const t=y(e).filter(t=>"core/post-template"===t?.name),n=new Set(t.map(t=>t.clientId));t.forEach(t=>{h(t.clientId),u(t.clientId),f.set(t.clientId,{s:parseInt(t.attributes?.aptStartFrom||0,10),c:parseInt(t.attributes?.aptShowCount||0,10),k:parseInt(t.attributes?.aptSkipLast||0,10)})}),k=new Set(n)}}catch(t){}},g=()=>{Array.from(document.querySelectorAll('iframe[name="editor-canvas"], .editor-canvas iframe, iframe.components-iframe__frame')).forEach(t=>{if(!I.has(t)){I.add(t),t.addEventListener("load",()=>{const e=t.contentWindow;E(e,()=>A(e))});try{t.contentWindow&&E(t.contentWindow,()=>A(t.contentWindow))}catch(t){}}})},v=new MutationObserver(()=>g());try{v.observe(document.documentElement,{childList:!0,subtree:!0})}catch(t){}g(),(0,c.subscribe)(()=>{const t=(0,c.select)("core/block-editor").getBlocks();if(!Array.isArray(t))return;const e=y(t).filter(t=>"core/post-template"===t?.name);if(0===e.length)return;const n=new Set(e.map(t=>t.clientId));e.forEach(t=>{h(t.clientId);const e={s:parseInt(t.attributes?.aptStartFrom||0,10),c:parseInt(t.attributes?.aptShowCount||0,10),k:parseInt(t.attributes?.aptSkipLast||0,10)},n=f.get(t.clientId);n&&n.s===e.s&&n.c===e.c&&n.k===e.k||(f.set(t.clientId,e),u(t.clientId))}),b(n),k=new Set(n)});try{const t=(0,c.select)("core/block-editor").getBlocks();if(Array.isArray(t)&&t.length){y(t).filter(t=>"core/post-template"===t?.name).forEach(t=>{h(t.clientId),u(t.clientId)})}}catch(t){}const C=(0,a.createHigherOrderComponent)(n=>a=>{if("core/post-template"!==a.name)return(0,t.createElement)(n,{...a});const{attributes:c,setAttributes:l}=a,{aptStartFrom:d,aptShowCount:p,aptSkipLast:m}=c;return(0,o.useEffect)(()=>{a.clientId&&(u(a.clientId),h(a.clientId))},[a.clientId]),(0,o.useEffect)(()=>{a.clientId&&u(a.clientId)},[a.clientId,d,p,m]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)(n,{...a}),(0,t.createElement)(r.InspectorControls,null,(0,t.createElement)(s.PanelBody,{title:(0,e.__)("Tronquer l’affichage","advanced-post-template"),initialOpen:!0},(0,t.createElement)(i,{label:(0,e.__)("Tronquer au début","advanced-post-template"),min:0,value:d,onChange:t=>l({aptStartFrom:parseInt(t||0,10)||0})}),(0,t.createElement)(i,{label:(0,e.__)("Maximum à afficher (0 = tous)","advanced-post-template"),min:0,value:p,onChange:t=>l({aptShowCount:Math.max(0,parseInt(t||0,10)||0)})}),(0,t.createElement)(i,{label:(0,e.__)("Tronquer à la fin","advanced-post-template"),min:0,value:m,onChange:t=>l({aptSkipLast:Math.max(0,parseInt(t||0,10)||0)})}))))},"withAPTControls");(0,n.addFilter)("editor.BlockEdit","wabeo/apt-controls",C)})();